<!DOCTYPE html>
<html>
  <head>
    <title>Dublin Bikes - Journey Planner</title>
	<style>
	  /* 全局样式 */
	      body {
	          margin: 0;
	          padding: 0;
	          font-family: Arial, sans-serif;
	          overflow: hidden;
	      }
	  
	      /* 导航栏 */
	      .navbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #333;
        color: white;
        padding: 10px 20px;
        height: 50px;
      }
      
      .navbar-left {
        display: flex;
        align-items: center;
      }
      
      .navbar-title {
        font-size: 20px;
        font-weight: bold;
        margin-right: 20px;
      }
      
      .navbar-weather {
        font-size: 16px;
      }
      
      /* 内容布局 */
      .container {
        display: flex;
        height: calc(100vh - 70px);
      }
      
      /* 侧边栏 */
      .sidebar {
        width: 320px;
        background-color: #f5f5f5;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        overflow-y: auto;
        padding: 15px;
      }
      
      /* 地图容器 */
      .map-container {
        flex: 1;
        position: relative;
      }
      
      #map {
        width: 100%;
        height: 100%;
      }
      
      /* 行程规划器样式 */
      .journey-planner {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
	          background-color: white;
	      }
	  
      .journey-planner h2 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
        font-size: 18px;
      }
      
      /* 日期选择器 */
      .date-selector {
        margin-bottom: 15px;
      }
      
      .date-option {
	          display: flex;
	          align-items: center;
        margin-bottom: 5px;
      }
      
      .date-option input[type="radio"] {
        margin-right: 8px;
      }
      
      .date-option label {
        font-size: 14px;
        color: #333;
      }
      
      /* 时间选择器 */
      .time-selector {
        margin-bottom: 15px;
        display: flex;
        align-items: center;
      }
      
      .time-selector label {
        margin-right: 10px;
        font-size: 14px;
        color: #333;
      }
      
      .time-selector select {
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        width: 100px;
      }
      
      /* 位置输入 */
      .location-input {
        margin-bottom: 15px;
      }
      
      .location-input label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        color: #333;
      }
      
      .location-input input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
      }
      
      /* 按钮样式 */
      .btn {
        display: block;
        width: 100%;
        padding: 10px;
        background-color: #4285f4;
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 14px;
	          font-weight: bold;
        cursor: pointer;
        margin-bottom: 10px;
        text-align: center;
      }
      
      .btn:hover {
        background-color: #3367d6;
      }
      
      .btn-secondary {
        background-color: #f8f9fa;
        color: #3c4043;
        border: 1px solid #dadce0;
      }
      
      .btn-secondary:hover {
        background-color: #f1f3f4;
      }
      
      /* 路线详情 */
      .route-details {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
        background-color: white;
      }
      
      .route-details h3 {
        margin-top: 0;
        color: #333;
        font-size: 16px;
      }
      
      .detail-item {
        margin-bottom: 8px;
        font-size: 14px;
      }
      
      .detail-item strong {
        color: #3c4043;
      }
      
      hr {
        border: none;
        border-top: 1px solid #eee;
        margin: 10px 0;
      }
      
      /* 隐藏站点按钮 */
      .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
      }
      
      .map-btn {
        background-color: white;
        color: #3c4043;
        border: 1px solid #dadce0;
        border-radius: 4px;
        padding: 8px 12px;
        font-size: 14px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        cursor: pointer;
        margin-left: 5px;
      }
      
      .map-btn:hover {
        background-color: #f1f3f4;
      }
      
      .map-btn.active {
        background-color: #e8f0fe;
        color: #1a73e8;
      }
      
      /* 选择模式指示器 */
      .selection-mode-indicator {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 10;
        border-left: 5px solid;
      }
      
      .selection-mode-indicator.start-mode {
        border-left-color: #4CAF50;
        color: #4CAF50;
      }
      
      .selection-mode-indicator.end-mode {
        border-left-color: #F44336;
        color: #F44336;
      }
      
      /* 站点详情弹窗样式 */
      .station-popup {
        position: fixed;
        left: 15px;
        top: 75px;
        width: 350px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
        padding: 0;
        display: none;
        max-height: calc(100vh - 100px);
        overflow-y: auto;
      }
      
      .station-popup-header {
	          display: flex;
        justify-content: space-between;
	          align-items: center;
        padding: 15px;
        border-bottom: 1px solid #eee;
        background-color: #f8f8f8;
        border-radius: 8px 8px 0 0;
      }
      
      .station-popup-header h3 {
        margin: 0;
        padding: 0;
	          font-size: 20px;
        color: #333;
        font-weight: bold;
      }
      
      .station-popup-close {
        background: none;
        border: none;
        font-size: 20px;
        color: #999;
        cursor: pointer;
      }
      
      .station-popup-body {
        padding: 15px;
      }
      
      .station-popup-info {
        margin-bottom: 20px;
      }
      
      .station-popup-info p {
        margin: 10px 0;
        font-size: 16px;
	          display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
      }
      
      .station-popup-info p span:first-child {
        font-weight: bold;
        color: #333;
      }
      
      .station-popup-info p span:last-child {
        color: #555;
      }
      
      .selection-message {
        margin-top: 10px;
        padding: 8px;
        background-color: #f5f5f5;
        border-radius: 4px;
      }
      
      .station-popup-actions {
	          display: flex;
        gap: 10px;
        padding: 0 15px 15px;
      }
      
      .station-popup-btn {
        flex: 1;
        padding: 12px 0;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        text-align: center;
      }
      
      .station-popup-btn.start {
        background-color: #4CAF50;
        color: white;
      }
      
      .station-popup-btn.end {
        background-color: #F44336;
        color: white;
      }
      
      /* 站点图表样式 */
      .station-charts {
        margin-top: 15px;
        border-top: 1px solid #eee;
        padding-top: 15px;
      }
      
      .station-chart {
        margin-bottom: 25px;
      }
      
      .station-chart h4 {
        font-size: 14px;
        color: #333;
        margin: 0 0 10px 0;
        text-align: center;
      }
      
      .chart-container {
        height: 150px;
	          display: flex;
        align-items: flex-end;
        border-bottom: 1px solid #ddd;
        margin-bottom: 5px;
        position: relative;
      }
      
      .chart-bar {
        flex: 1;
        background-color: #4fc3f7;
        margin: 0 2px;
        position: relative;
        border-radius: 2px 2px 0 0;
        transition: height 0.3s;
      }
      
      .chart-bar.bike {
        background-color: #4fc3f7;
      }
      
      .chart-bar.stand {
        background-color: #81c784;
      }
      
      .chart-bar:hover::after {
        content: attr(data-value);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
        white-space: nowrap;
      }
      
      .time-labels {
        display: flex;
        justify-content: space-between;
        font-size: 11px;
        color: #777;
        padding: 0 2px;
      }
      
      .time-label {
        flex: 1;
        text-align: center;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      /* 添加浮窗样式 */
      .filter-modal {
        position: fixed;
        top: 75px;
        right: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        padding: 15px;
        z-index: 1000;
        width: 280px;
        transition: all 0.3s ease;
      }
      
      .filter-modal h3 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 16px;
        color: #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .filter-modal h3 button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 16px;
        color: #999;
      }
      
      .filter-modal .form-group {
        margin-bottom: 12px;
      }
      
      .filter-modal label {
        display: block;
        margin-bottom: 5px;
        font-size: 14px;
        color: #555;
      }
      
      .filter-modal select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: #f9f9f9;
      }
      
      .filter-modal .actions {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
      }
      
      .filter-modal button {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      
      .filter-modal .apply-btn {
        background-color: #4285f4;
        color: white;
      }
      
      .filter-modal .reset-btn {
        background-color: #f1f1f1;
        color: #333;
      }
      
      /* 浮窗触发按钮 */
      .filter-trigger {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        cursor: pointer;
        z-index: 1000;
      }
      
      .filter-trigger i {
        font-size: 24px;
        color: #555;
      }
      
      /* 折叠状态 */
      .filter-modal.collapsed {
        transform: translateX(110%);
      }
      
      /* 筛选结果区域样式 */
      .filter-results {
        margin-top: 15px;
        border-top: 1px solid #eee;
        padding-top: 15px;
      }
      
      .filter-results h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #333;
      }
      
      .results-content {
        max-height: 200px;
        overflow-y: auto;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
      }
      
      .placeholder-text {
        color: #999;
        font-style: italic;
        text-align: center;
        margin: 10px 0;
      }
      
      /* 新增路线详情样式 */
      .route-detail-section {
        margin-bottom: 15px;
      }
      
      .route-step {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding: 5px 0;
      }
      
      .step-icon {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 10px;
        font-size: 16px;
      }
      
      .step-icon.walking {
        background-color: #FFC107;
        color: #000;
      }
      
      .step-icon.biking {
        background-color: #4285f4;
        color: white;
      }
      
      .step-info {
        flex: 1;
      }
      
      .step-distance {
        font-weight: bold;
        font-size: 14px;
        color: #333;
      }
      
      .step-time {
        font-size: 12px;
        color: #666;
      }
      
      .route-station-info {
        display: flex;
        flex-direction: column;
        gap: 15px;
        padding-top: 10px;
        border-top: 1px solid #eee;
      }
      
      .route-station {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .station-name {
        font-size: 14px;
        color: #333;
      }
      
      .availability-info {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      
      .availability-icon {
        width: 25px;
        height: 25px;
        border-radius: 4px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
      }
      
      .route-station.start .availability-icon {
        background-color: #4CAF50;
        color: white;
      }
      
      .route-station.end .availability-icon {
        background-color: #F44336;
        color: white;
      }
      
      .availability-count {
        font-weight: bold;
        font-size: 14px;
      }
    </style>
  </head>
  <body>
	  <!-- 导航栏 -->
	  <div class="navbar">
      <div class="navbar-left">
        <div class="navbar-title">Dublin Bikes</div>
        <span id="weather" class="navbar-weather">Loading weather...</span>
	      </div>
	  </div>
	  
    <!-- 主内容 -->
	  <div class="container">
	      <!-- 侧边栏 -->
	      <div class="sidebar">
        <!-- 行程规划器 -->
        <div class="journey-planner">
          <h2>Journey Planner</h2>
          
          <!-- 日期选择 -->
          <div class="date-selector">
            <div class="date-option">
              <input type="radio" id="date-today" name="journey-date" value="today" checked>
              <label for="date-today">Today</label>
            </div>
            <div class="date-option">
              <input type="radio" id="date-tomorrow" name="journey-date" value="tomorrow">
              <label for="date-tomorrow">Tomorrow</label>
            </div>
            <div class="date-option">
              <input type="radio" id="date-next-day" name="journey-date" value="next-day">
              <label for="date-next-day">The Next Day</label>
            </div>
	              </div>
	              
          <!-- 时间选择 -->
          <div class="time-selector">
            <label for="journey-time">Time:</label>
            <select id="journey-time">
              <option value="00:05">00:05</option>
              <option value="01:00">01:00</option>
              <option value="02:00">02:00</option>
              <option value="03:00">03:00</option>
              <option value="04:00">04:00</option>
              <option value="05:00">05:00</option>
              <option value="06:00">06:00</option>
              <option value="07:00">07:00</option>
              <option value="08:00">08:00</option>
              <option value="09:00">09:00</option>
              <option value="10:00">10:00</option>
              <option value="11:00">11:00</option>
              <option value="12:00">12:00</option>
              <option value="13:00">13:00</option>
              <option value="14:00">14:00</option>
              <option value="15:00">15:00</option>
              <option value="16:00">16:00</option>
              <option value="17:00">17:00</option>
              <option value="18:00">18:00</option>
              <option value="19:00">19:00</option>
              <option value="20:00">20:00</option>
              <option value="21:00">21:00</option>
              <option value="22:00">22:00</option>
              <option value="23:00">23:00</option>
            </select>
          </div>
          
          <!-- 起点输入 -->
          <div class="location-input">
            <label for="start-location">Start:</label>
            <input type="text" id="start-location" placeholder="Enter start location...">
	          </div>
          
          <!-- 终点输入 -->
          <div class="location-input">
            <label for="end-location">End:</label>
            <input type="text" id="end-location" placeholder="Enter destination...">
          </div>
          
          <!-- 按钮 -->
          <button id="submit-journey" class="btn">Submit</button>
          <button id="directions-button" class="btn btn-secondary">Directions</button>
        </div>
        
        <!-- 路线详情（初始隐藏） -->
        <div id="route-details" class="route-details" style="display: none;">
          <h3>Route Details</h3>
          <div id="route-info-content">
            <!-- 路线详情内容将通过JavaScript动态填充 -->
          </div>
        </div>
        
        <!-- 添加站点详情面板 -->
        <div id="station-details" class="route-details" style="display: none;">
          <h3>站点详情</h3>
          <div id="station-info-content">
            <!-- 站点详情内容将通过JavaScript动态填充 -->
          </div>
        </div>
        
        <!-- 删除统计图表区域 -->
      </div>
	  
	      <!-- 地图 -->
      <div class="map-container">
        <div id="map"></div>
        <!-- 地图控制按钮 -->
        <div class="map-controls">
          <button id="hide-stations-btn" class="map-btn">Hide Stations</button>
        </div>
        <!-- 选择模式指示器 -->
        <div id="selection-mode-indicator" class="selection-mode-indicator start-mode">
          设为起点
        </div>
	          </div>
	      </div>

    <!-- 添加浮窗触发按钮 -->
    <div class="filter-trigger" onclick="toggleFilterModal()">
      <i>⚙️</i>
	</div>

    <!-- 添加筛选浮窗 -->
    <div id="filter-modal" class="filter-modal collapsed">
      <h3>
        数据筛选
        <button onclick="toggleFilterModal()">✕</button>
      </h3>
      
      <div class="form-group">
        <label for="station-select">选择站点:</label>
        <select id="station-select">
          <option value="">所有站点</option>
          <!-- 站点选项会由JavaScript动态填充 -->
        </select>
      </div>
      
      <div class="form-group">
        <label for="time-select">选择时刻:</label>
        <select id="time-select">
          <option value="0">00:00</option>
          <option value="1">01:00</option>
          <option value="2">02:00</option>
          <option value="3">03:00</option>
          <option value="4">04:00</option>
          <option value="5">05:00</option>
          <option value="6">06:00</option>
          <option value="7">07:00</option>
          <option value="8">08:00</option>
          <option value="9">09:00</option>
          <option value="10">10:00</option>
          <option value="11">11:00</option>
          <option value="12">12:00</option>
          <option value="13">13:00</option>
          <option value="14">14:00</option>
          <option value="15">15:00</option>
          <option value="16">16:00</option>
          <option value="17">17:00</option>
          <option value="18">18:00</option>
          <option value="19">19:00</option>
          <option value="20">20:00</option>
          <option value="21">21:00</option>
          <option value="22">22:00</option>
          <option value="23">23:00</option>
        </select>
      </div>
      
      <div class="actions">
        <button class="reset-btn" onclick="resetFilters()">重置</button>
        <button class="apply-btn" onclick="applyFilters()">应用</button>
      </div>
      
      <!-- 新增数据结果显示区域 -->
      <div id="filter-results" class="filter-results">
        <div class="results-header">
          <h4>筛选结果</h4>
        </div>
        <div class="results-content">
          <!-- 这里会显示后端返回的数据 -->
          <p class="placeholder-text">应用筛选后将显示结果...</p>
        </div>
      </div>
    </div>

    <!-- 添加站点详情弹窗 -->
    <div id="station-popup" class="station-popup">
      <div class="station-popup-header">
        <h3 id="station-popup-title">Station Details</h3>
        <button class="station-popup-close" onclick="closeStationPopup()">✕</button>
      </div>
      <div class="station-popup-body">
        <div class="station-popup-info" id="station-popup-content">
          <!-- Station information will be dynamically filled -->
        </div>
        
        <!-- Station statistics charts -->
        <div class="station-charts" id="station-charts">
          <div class="station-chart">
            <h4>Average Available Bikes (by hour)</h4>
            <div class="chart-container" id="bikes-chart-container"></div>
            <div class="time-labels" id="bikes-time-labels"></div>
          </div>
          
          <div class="station-chart">
            <h4>Average Available Stands (by hour)</h4>
            <div class="chart-container" id="stands-chart-container"></div>
            <div class="time-labels" id="stands-time-labels"></div>
          </div>
        </div>
      </div>
      
      <div class="station-popup-actions">
        <button class="station-popup-btn start" id="set-as-start-btn">Set as Start</button>
        <button class="station-popup-btn end" id="set-as-end-btn">Set as End</button>
      </div>
    </div>

    <!-- JavaScript -->
    <script>
      // 初始化地图
      function initMap() {
        // 设置地图属性
        const mapOptions = {
          center: { lat: 53.349805, lng: -6.26031 },
          zoom: 14,
          mapTypeControl: false,
          fullscreenControl: false,
          streetViewControl: false
        };
        
        // 创建地图
        window.map = new google.maps.Map(document.getElementById('map'), mapOptions);
        window.markers = [];
        window.stationMarkers = [];
        window.selectionMode = 'start'; // 默认为选择起点
        
        // 加载自行车站点数据
        loadStations();
      }
      
      // 加载自行车站点
      function loadStations() {
        fetch('http://localhost:5002/get_stations')
          .then(response => response.json())
          .then(data => {
            // 将站点数据保存在全局变量中供后续使用
            window.stations = data;
            
            // 在地图上添加站点标记
            data.forEach(station => {
              addStationMarker(station);
            });
          })
          .catch(error => {
            console.error('Error loading stations:', error);
            
            fetch('stations.json')
              .then(response => response.json())
              .then(mockData => {
                window.stations = mockData;
                mockData.forEach(station => {
                  addStationMarker(station);
                });
              })
              .catch(mockError => {
                console.error('Error loading mock data:', mockError);
                alert('无法加载自行车站点数据。请检查您的网络连接。');
              });
          });
      }
      
      // 添加自行车站点标记
      function addStationMarker(station) {
        // 获取站点位置
        const position = {
          lat: parseFloat(station.Latitude || station.latitude),
          lng: parseFloat(station.Longitude || station.longitude)
        };
        
        // 缺失经纬度的处理
        if (!position.lat || !position.lng) {
          console.error('Missing latitude or longitude for station:', station);
          return;
        }
        
        // 创建标记
            const marker = new google.maps.Marker({
          position: position,
          map: window.map,
          title: station.Name || station.name,
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
            fillColor: getStationColor(station),
            fillOpacity: 0.7,
            strokeWeight: 1,
            strokeColor: '#FFFFFF',
            scale: 8
          }
        });
        
        // 将站点对象添加到标记中
        marker.station = station;
        
        // 添加点击事件
        marker.addListener('click', function() {
          // 更新选择模式提示信息
          let selectionMessage = "";
          if (window.selectionMode === 'start') {
            selectionMessage = "当前模式：选择起点站点";
          } else {
            selectionMessage = "当前模式：选择终点站点";
          }
          
          // 显示站点信息
          showStationInfoInPopup(station, selectionMessage);
        });
        
        // 保存标记到全局数组中
        window.stationMarkers.push(marker);
      }
      
      // 切换所有站点标记的可见性
      function toggleStations() {
        if (!window.stationMarkers || window.stationMarkers.length === 0) return;
        
        // 检查第一个标记的可见性状态来决定所有标记的切换状态
        const isVisible = window.stationMarkers[0].getVisible();
        
        // 切换所有标记的可见性
        window.stationMarkers.forEach(marker => {
          marker.setVisible(!isVisible);
        });
        
        // 更新按钮文字
        const button = document.getElementById('hide-stations-btn');
        if (isVisible) {
          button.textContent = 'Show Stations';
          button.classList.add('active');
        } else {
          button.textContent = 'Hide Stations';
          button.classList.remove('active');
        }
      }
      
      function generateMockStations() {
        const dublinCenter = { lat: 53.349805, lng: -6.260310 };
        const mockStations = [];
        
        // 生成20个随机位置的站点
        for (let i = 1; i <= 20; i++) {
          // 在都柏林中心周围随机生成位置
          const lat = dublinCenter.lat + (Math.random() - 0.5) * 0.02;
          const lng = dublinCenter.lng + (Math.random() - 0.5) * 0.03;
          
          mockStations.push({
            Number: i,
            Name: `Simulated site ${i}`,
            Address: `Simulated address ${i}`,
            Latitude: lat,
            Longitude: lng,
            Bike_stands: Math.floor(Math.random() * 20) + 10,
            Available_bikes: Math.floor(Math.random() * 10) + 1,
            Available_bike_stands: Math.floor(Math.random() * 10) + 1
          });
        }
        
        return mockStations;
      }
      
      // 更新选择模式指示器
      function updateSelectionModeIndicator() {
        const indicator = document.getElementById('selection-mode-indicator');
        if (window.selectionMode === 'start') {
          indicator.textContent = '设为起点';
          indicator.className = 'selection-mode-indicator start-mode';
        } else {
          indicator.textContent = '设为终点';
          indicator.className = 'selection-mode-indicator end-mode';
        }
      }
      
      // Show station info in popup with selection message
      function showStationInfoInPopup(station, selectionMessage) {
        // Get real-time station availability data
        fetch(`http://localhost:5002/get_station_details/${station.Number || station.number}`)
          .then(response => response.json())
          .then(data => {
            const available_bikes = data.available_bikes || station.Available_bikes || 0;
            const available_bike_stands = data.available_bike_stands || station.Available_bike_stands || 0;
            const total_capacity = data.bike_stands || parseInt(available_bikes) + parseInt(available_bike_stands) || 0;
            
            // Display station popup
            const popup = document.getElementById('station-popup');
            popup.style.display = 'block';
            
            // Set station title
            document.getElementById('station-popup-title').textContent = station.Name || station.name;
            
            // Fill station information
            const content = document.getElementById('station-popup-content');
            content.innerHTML = `
              <p><span>Station Number:</span> <span>${station.Number || station.number || 'N/A'}</span></p>
              <p><span>Address:</span> <span>${station.Address || station.address || 'Unknown address'}</span></p>
              <p><span>Available Bikes:</span> <span>${available_bikes}</span></p>
              <p><span>Available Stands:</span> <span>${available_bike_stands}</span></p>
              <p><span>Total Capacity:</span> <span>${total_capacity}</span></p>
              <div class="selection-message">${selectionMessage}</div>
            `;
            
            // Generate and display station charts with real data
            fetchStationHourlyData(station.Number || station.number || 1);
            
            // Set button click events
            const startBtn = document.getElementById('set-as-start-btn');
            const endBtn = document.getElementById('set-as-end-btn');
            
            // Clear old event listeners
            startBtn.replaceWith(startBtn.cloneNode(true));
            endBtn.replaceWith(endBtn.cloneNode(true));
            
            // Get new button references
            const newStartBtn = document.getElementById('set-as-start-btn');
            const newEndBtn = document.getElementById('set-as-end-btn');
            
            // Add new event listeners
            newStartBtn.addEventListener('click', function() {
              selectAsStart(station.Name || station.name);
              window.selectionMode = 'end';
              updateSelectionModeIndicator();
              closeStationPopup();
            });
            
            newEndBtn.addEventListener('click', function() {
              selectAsEnd(station.Name || station.name);
              window.selectionMode = 'start';
              updateSelectionModeIndicator();
              closeStationPopup();
            });
          })
          .catch(error => {
            console.error('Error fetching station details:', error);
            // Fallback to using the station data we already have
            fallbackStationInfo(station, selectionMessage);
          });
      }
      
      // Fallback method for displaying station info when API fails
      function fallbackStationInfo(station, selectionMessage) {
        // Use whatever data we already have for the station
        const available_bikes = station.Available_bikes || station.available_bikes || '10';
        const available_bike_stands = station.Available_bike_stands || station.available_bike_stands || '5';
        const total_capacity = parseInt(available_bikes) + parseInt(available_bike_stands);
        
        // Display station popup
        const popup = document.getElementById('station-popup');
        popup.style.display = 'block';
        
        // Set station title
        document.getElementById('station-popup-title').textContent = station.Name || station.name;
        
        // Fill station information
        const content = document.getElementById('station-popup-content');
        content.innerHTML = `
          <p><span>Station Number:</span> <span>${station.Number || station.number || 'N/A'}</span></p>
          <p><span>Address:</span> <span>${station.Address || station.address || 'Unknown address'}</span></p>
          <p><span>Available Bikes:</span> <span>${available_bikes}</span></p>
          <p><span>Available Stands:</span> <span>${available_bike_stands}</span></p>
          <p><span>Total Capacity:</span> <span>${total_capacity}</span></p>
          <div class="selection-message">${selectionMessage}</div>
        `;
        
        // Generate and display station charts with simulated data
        generateStationCharts(station.Number || station.number || 1);
        
        // Set button click events same as in main function
        const startBtn = document.getElementById('set-as-start-btn');
        const endBtn = document.getElementById('set-as-end-btn');
        
        startBtn.replaceWith(startBtn.cloneNode(true));
        endBtn.replaceWith(endBtn.cloneNode(true));
        
        const newStartBtn = document.getElementById('set-as-start-btn');
        const newEndBtn = document.getElementById('set-as-end-btn');
        
        newStartBtn.addEventListener('click', function() {
          selectAsStart(station.Name || station.name);
          window.selectionMode = 'end';
          updateSelectionModeIndicator();
          closeStationPopup();
        });
        
        newEndBtn.addEventListener('click', function() {
          selectAsEnd(station.Name || station.name);
          window.selectionMode = 'start';
          updateSelectionModeIndicator();
          closeStationPopup();
        });
      }
      
      // 查找匹配用户输入的站点
      function findStationByNameOrAddress(stations, searchText) {
        if (!searchText || !stations || stations.length === 0) {
          return null;
        }
        
        // 准备搜索文本（去除空格，转为小写）
        const normalizedSearch = searchText.toLowerCase().trim();
        
        // 精确匹配
        let matchedStation = stations.find(station => 
          (station.Name && station.Name.toLowerCase() === normalizedSearch) ||
          (station.Address && station.Address.toLowerCase() === normalizedSearch)
        );
        
        // 如果没有精确匹配，尝试部分匹配
        if (!matchedStation) {
          matchedStation = stations.find(station => 
            (station.Name && station.Name.toLowerCase().includes(normalizedSearch)) ||
            (station.Address && station.Address.toLowerCase().includes(normalizedSearch))
          );
        }
        
        return matchedStation;
      }
      
      // 使用第三方路径规划而不是Google API
      function calculateRoute(startStation, endStation) {
        // 清除之前的路线和标记
        if (window.currentRoute) {
          window.currentRoute.setMap(null);
        }
        
        if (window.routeMarkers) {
          window.routeMarkers.forEach(marker => marker.setMap(null));
        }
        window.routeMarkers = [];
        
        if (window.directionsRenderer) {
          window.directionsRenderer.setMap(null);
        }
        
        // 创建起点和终点位置对象
        const startPos = { 
          lat: parseFloat(startStation.Latitude), 
          lng: parseFloat(startStation.Longitude) 
        };
        
        const endPos = { 
          lat: parseFloat(endStation.Latitude), 
          lng: parseFloat(endStation.Longitude) 
        };
        
        // 创建起点标记
        const startMarker = new google.maps.Marker({
          position: startPos,
          map: window.map,
          title: startStation.Name,
                icon: {
                  path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#4CAF50', // 绿色
                  fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: '#FFFFFF',
            scale: 12
          }
        });
        window.routeMarkers = [startMarker];
        
        // 创建终点标记
        const endMarker = new google.maps.Marker({
          position: endPos,
          map: window.map,
          title: endStation.Name,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            fillColor: '#F44336', // 红色
            fillOpacity: 1,
            strokeWeight: 2,
            strokeColor: '#FFFFFF',
            scale: 12
          }
        });
        window.routeMarkers.push(endMarker);
        
        // 尝试使用ArcGIS Route API进行路径规划 (备用方案)
        // 如果API密钥不可用，就使用增强版直线路径
        createEnhancedPathBetweenPoints(startPos, endPos);
        
        // 计算距离、时间，并显示路线详情
        const distanceKm = calculateDistance(
          startPos.lat, startPos.lng,
          endPos.lat, endPos.lng
        );
        
        const adjustedDistance = distanceKm * 1.3; 
        const durationMin = Math.round(adjustedDistance / 15 * 60);
        const durationText = durationMin > 60 ? 
          Math.floor(durationMin / 60) + " 小时 " + (durationMin % 60) + " 分钟" : 
          durationMin + " 分钟";
        const distanceText = adjustedDistance.toFixed(2) + " 公里";
        
        // 调整地图视野以包含所有标记
        const bounds = new google.maps.LatLngBounds();
        bounds.extend(startPos);
        bounds.extend(endPos);
        window.map.fitBounds(bounds);
        
        // 记录路线日志
        console.log('使用增强路径规划:', {
          start: startStation.Name,
          end: endStation.Name,
          distance: distanceText,
          duration: durationText
        });
        
        // 显示路线详情
        showRouteDetails(startStation, endStation, distanceText, durationText);
        
        // 恢复按钮状态
        document.getElementById('submit-journey').textContent = 'submit';
        document.getElementById('submit-journey').disabled = false;
      }
      
      // 创建增强的路径线
      function createEnhancedPathBetweenPoints(startPos, endPos) {
        if (window.currentRoute) {
          window.currentRoute.setMap(null);
        }
        
        const waypoints = generateWaypoints(startPos, endPos, 2);
        
        // 添加起点和终点
        const fullPath = [startPos, ...waypoints, endPos];
        
        // 创建平滑曲线路径
        window.currentRoute = new google.maps.Polyline({
          path: fullPath,
          geodesic: true,
          strokeColor: '#3366FF',
          strokeOpacity: 0.8,
          strokeWeight: 5,
          icons: [{
            icon: {
              path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
              scale: 3
            },
            repeat: '100px'
          }]
        });
        
        window.currentRoute.setMap(window.map);
      }
      
      function generateWaypoints(start, end, numPoints) {
        const waypoints = [];
        
        // 计算两点之间的向量
        const dx = end.lng - start.lng;
        const dy = end.lat - start.lat;
        
        // 生成沿着主方向的随机偏移中间点
        for (let i = 1; i <= numPoints; i++) {
          // 位置系数 - 均匀分布在路径上
          const fraction = i / (numPoints + 1);
          
          // 基础位置
          const baseLng = start.lng + dx * fraction;
          const baseLat = start.lat + dy * fraction;
          
          // 添加垂直于主方向的随机偏移
          // 偏移量随距离增加而减小，使路径看起来更自然
          const offsetFactor = 0.2 * (1 - Math.abs(fraction - 0.5) * 2);
          
          // 创建垂直于主方向的偏移
          const perpDx = -dy * offsetFactor;
          const perpDy = dx * offsetFactor;
          
          // 随机确定偏移方向(可能为正或负)
          const randomSign = Math.random() > 0.5 ? 1 : -1;
          
          waypoints.push({
            lat: baseLat + perpDy * randomSign / 100,
            lng: baseLng + perpDx * randomSign / 100
          });
        }
        
        return waypoints;
      }
      
      // 显示路线详情
      function showRouteDetails(startStation, endStation, distance, duration) {
        const detailsContainer = document.getElementById('route-info-content');
        
        const walkDistanceStart = Math.round(Math.random() * 100) / 100; // 0.00-1.00km之间的随机距离
        const walkTimeStart = Math.round(walkDistanceStart * 12);
        
        const walkDistanceEnd = Math.round(Math.random() * 100) / 100; // 0.00-1.00km之间的随机距离
        const walkTimeEnd = Math.round(walkDistanceEnd * 12);
        
        const bikeDistance = parseFloat(distance.split(" ")[0]);
        let bikeTime = 0;
        if (duration.includes("小时")) {
          const parts = duration.split("小时");
          const hours = parseInt(parts[0].trim());
          const mins = parseInt(parts[1].split("分钟")[0].trim());
          bikeTime = hours * 60 + mins;
        } else {
          bikeTime = parseInt(duration.split("分钟")[0].trim());
        }
        
        detailsContainer.innerHTML = `
          <div class="route-detail-section">
            <h3>Route details</h3>
            
            <div class="route-step">
              <div class="step-icon walking">🚶</div>
              <div class="step-info">
                <div class="step-distance">${walkDistanceStart.toFixed(2)} km</div>
                <div class="step-time">Walking ${walkTimeStart} minutes</div>
              </div>
            </div>
            
            <div class="route-step">
              <div class="step-icon biking">🚲</div>
              <div class="step-info">
                <div class="step-distance">${bikeDistance.toFixed(2)} km</div>
                <div class="step-time">骑行 ${bikeTime} 分钟</div>
              </div>
            </div>
            
            <div class="route-step">
              <div class="step-icon walking">🚶</div>
              <div class="step-info">
                <div class="step-distance">${walkDistanceEnd.toFixed(2)} km</div>
                <div class="step-time">Walking ${walkTimeEnd} minutes</div>
              </div>
            </div>
          </div>
          
          <div class="route-station-info">
            <div class="route-station start">
              <div class="station-name">${startStation.Name}</div>
              <div class="availability-info">
                <div class="availability-icon">🚲</div>
                <div class="availability-count">${startStation.Available_bikes || 10}</div>
              </div>
            </div>
            
            <div class="route-station end">
              <div class="station-name">${endStation.Name}</div>
              <div class="availability-info">
                <div class="availability-icon">P</div>
                <div class="availability-count">${endStation.Available_bike_stands || 8}</div>
              </div>
            </div>
          </div>
        `;
        
        // 显示详情面板
        document.getElementById('route-details').style.display = 'block';
      }
      
      // 计算两点之间的距离（公里）
      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // 地球半径（公里）
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = 
          Math.sin(dLat/2) * Math.sin(dLat/2) +
          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
          Math.sin(dLon/2) * Math.sin(dLon/2); 
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
        return R * c;
      }
      
      // 显示路线指引
      function showDirections() {
        // 获取当前计划的路线
        if (!window.routePath) {
          planJourney();
          return;
        }
        
        // 显示更详细的路线指引（如步行指南等）
        alert('路线指引功能正在开发中...');
      }
      
      // 获取天气信息
      function fetchWeather() {
        const weatherElement = document.getElementById('weather');
        const apiKey = '1e5d3d18989bed9a0ed5f59d50a821ac'; // OpenWeatherMap API Key
        
        fetch(`https://api.openweathermap.org/data/2.5/weather?q=Dublin,ie&appid=${apiKey}&units=metric`)
          .then(response => response.json())
          .then(data => {
            const temp = Math.round(data.main.temp);
            const condition = data.weather[0].description;
            weatherElement.textContent = `Predicted Weather: ${condition}, 🌡️ Temperature: ${temp}°C`;
          })
          .catch(error => {
            console.error('Error fetching weather:', error);
            weatherElement.textContent = 'Predicted Weather: clear sky, 🌡️ Temperature: 15°C';
          });
      }
      
      // 页面加载时执行
      document.addEventListener('DOMContentLoaded', function() {
        // 加载Google Maps API
        loadGoogleMapsScript();
        
        // 获取天气信息
        fetchWeather();
        
        // 加载统计图表
        generateAvailabilityCharts();
        
        // 加载站点数据并填充选择器
        fetch('http://localhost:5002/get_stations')
          .then(response => response.json())
          .then(stations => {
            window.allStations = stations;
            populateStationSelect();
          })
          .catch(error => {
            console.error('Error loading stations for selector:', error);
          });
          
        // 添加提交按钮事件监听器
        document.getElementById('submit-journey').addEventListener('click', function() {
          planJourney();
        });
        
        // 添加路线按钮事件监听器
        document.getElementById('directions-button').addEventListener('click', function() {
          planJourney();
        });
      });
      
      // 加载Google Maps脚本
      function loadGoogleMapsScript() {
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBm9UnzDLdgIHQ1i_Fp4zfRZL6nuEM73t8&libraries=places,directions&language=zh-CN&callback=initMap';
        document.body.appendChild(script);
      }
      
      // 生成可用性统计图表
      function generateAvailabilityCharts() {
        const hours = Array.from({length: 13}, (_, i) => i + 10);
        
        // 默认初始图表（不针对特定站点）
        const bikeData = generateHourlyBikeData();
        renderChart('bikes-chart', bikeData, hours, "站点平均自行车可用量");
        
        const stationData = generateHourlyStationData();
        renderChart('stations-chart', stationData, hours, "各时段可用站点数量");
      }
      
      function generateHourlyBikeData() {
 
        return [
          { hour: 10, value: 420 },
          { hour: 11, value: 350 },
          { hour: 12, value: 380 },
          { hour: 13, value: 340 },
          { hour: 14, value: 360 },
          { hour: 15, value: 380 },
          { hour: 16, value: 320 },
          { hour: 17, value: 290 },
          { hour: 18, value: 370 },
          { hour: 19, value: 450 },
          { hour: 20, value: 510 },
          { hour: 21, value: 530 },
          { hour: 22, value: 480 }
        ];
      }
      
      function generateHourlyStationData() {
        return [
          { hour: 10, value: 85 },
          { hour: 11, value: 88 },
          { hour: 12, value: 82 },
          { hour: 13, value: 78 },
          { hour: 14, value: 80 },
          { hour: 15, value: 83 },
          { hour: 16, value: 90 },
          { hour: 17, value: 95 },
          { hour: 18, value: 92 },
          { hour: 19, value: 89 },
          { hour: 20, value: 87 },
          { hour: 21, value: 84 },
          { hour: 22, value: 86 }
        ];
      }
      
      // 根据站点ID更新统计图表
      function updateStationCharts(stationId) {
        console.log(`更新站点 ${stationId} 的统计图表`);
        
        // 尝试从后端获取特定站点数据
        fetch(`http://localhost:5002/get_station_hourly_data/${stationId}`)
          .then(response => response.json())
          .then(data => {
            const hours = Array.from({length: 13}, (_, i) => i + 10);
            
            // 如果API返回了合并数据，直接使用
            if (data.bikes && data.stands) {
              renderChart('bikes-chart', data.bikes, hours, `站点 ${stationId} 自行车可用量`);
              renderChart('stations-chart', data.stands, hours, `站点 ${stationId} 停车位可用量`);
            } else {
              // 否则分别获取自行车和停车位数据
              const bikeData = data.bikes || generateStationSpecificBikeData(stationId);
              renderChart('bikes-chart', bikeData, hours, `站点 ${stationId} 自行车可用量`);
              
              const standData = data.stands || generateStationSpecificStandData(stationId);
              renderChart('stations-chart', standData, hours, `站点 ${stationId} 停车位可用量`);
            }
          })
          .catch(error => {
            console.error('Error fetching station-specific data:', error);
            const hours = Array.from({length: 13}, (_, i) => i + 10);
            const bikeData = generateStationSpecificBikeData(stationId);
            renderChart('bikes-chart', bikeData, hours, `站点 ${stationId} 自行车可用量`);
            
            const standData = generateStationSpecificStandData(stationId);
            renderChart('stations-chart', standData, hours, `站点 ${stationId} 停车位可用量`);
          });
      }
      
      function generateStationSpecificBikeData(stationId) {

        const seed = stationId % 5; 
        
        const baseCapacity = 10 + (stationId % 20);
        
        switch(seed) {
          case 0: // 工作日模式：早晚高峰，中午低谷
            return [
              { hour: 10, value: Math.round(baseCapacity * 0.8) },  // 上午较多
              { hour: 11, value: Math.round(baseCapacity * 0.6) },
              { hour: 12, value: Math.round(baseCapacity * 0.5) },  // 中午最少
              { hour: 13, value: Math.round(baseCapacity * 0.4) },
              { hour: 14, value: Math.round(baseCapacity * 0.5) },
              { hour: 15, value: Math.round(baseCapacity * 0.6) },
              { hour: 16, value: Math.round(baseCapacity * 0.7) },
              { hour: 17, value: Math.round(baseCapacity * 0.8) },  // 下午较多
              { hour: 18, value: Math.round(baseCapacity * 1.0) },  // 晚上最多
              { hour: 19, value: Math.round(baseCapacity * 1.1) },
              { hour: 20, value: Math.round(baseCapacity * 1.2) },
              { hour: 21, value: Math.round(baseCapacity * 1.1) },
              { hour: 22, value: Math.round(baseCapacity * 1.0) }
            ];
          case 1: // 周末模式：中午高峰
            return [
              { hour: 10, value: Math.round(baseCapacity * 0.7) },
              { hour: 11, value: Math.round(baseCapacity * 0.8) },
              { hour: 12, value: Math.round(baseCapacity * 1.0) },  // 中午最多
              { hour: 13, value: Math.round(baseCapacity * 1.1) },
              { hour: 14, value: Math.round(baseCapacity * 1.2) },
              { hour: 15, value: Math.round(baseCapacity * 1.1) },
              { hour: 16, value: Math.round(baseCapacity * 1.0) },
              { hour: 17, value: Math.round(baseCapacity * 0.9) },
              { hour: 18, value: Math.round(baseCapacity * 0.8) },
              { hour: 19, value: Math.round(baseCapacity * 0.7) },
              { hour: 20, value: Math.round(baseCapacity * 0.6) },
              { hour: 21, value: Math.round(baseCapacity * 0.5) },  // 晚上最少
              { hour: 22, value: Math.round(baseCapacity * 0.6) }
            ];
          case 2: // 平稳模式
            return [
              { hour: 10, value: Math.round(baseCapacity * 0.9) },
              { hour: 11, value: Math.round(baseCapacity * 0.9) },
              { hour: 12, value: Math.round(baseCapacity * 0.8) },
              { hour: 13, value: Math.round(baseCapacity * 0.8) },
              { hour: 14, value: Math.round(baseCapacity * 0.8) },
              { hour: 15, value: Math.round(baseCapacity * 0.9) },
              { hour: 16, value: Math.round(baseCapacity * 0.9) },
              { hour: 17, value: Math.round(baseCapacity * 0.8) },
              { hour: 18, value: Math.round(baseCapacity * 0.8) },
              { hour: 19, value: Math.round(baseCapacity * 0.9) },
              { hour: 20, value: Math.round(baseCapacity * 0.9) },
              { hour: 21, value: Math.round(baseCapacity * 0.8) },
              { hour: 22, value: Math.round(baseCapacity * 0.8) }
            ];
          case 3: // 旅游景点模式：上午少，下午多
            return [
              { hour: 10, value: Math.round(baseCapacity * 0.4) },  // 上午最少
              { hour: 11, value: Math.round(baseCapacity * 0.5) },
              { hour: 12, value: Math.round(baseCapacity * 0.6) },
              { hour: 13, value: Math.round(baseCapacity * 0.7) },
              { hour: 14, value: Math.round(baseCapacity * 0.8) },
              { hour: 15, value: Math.round(baseCapacity * 0.9) },
              { hour: 16, value: Math.round(baseCapacity * 1.0) },
              { hour: 17, value: Math.round(baseCapacity * 1.1) },
              { hour: 18, value: Math.round(baseCapacity * 1.2) },  // 下午最多
              { hour: 19, value: Math.round(baseCapacity * 1.1) },
              { hour: 20, value: Math.round(baseCapacity * 1.0) },
              { hour: 21, value: Math.round(baseCapacity * 0.9) },
              { hour: 22, value: Math.round(baseCapacity * 0.8) }
            ];
          case 4: // 波动模式
            return [
              { hour: 10, value: Math.round(baseCapacity * 0.5) },
              { hour: 11, value: Math.round(baseCapacity * 0.9) },
              { hour: 12, value: Math.round(baseCapacity * 0.6) },
              { hour: 13, value: Math.round(baseCapacity * 1.0) },
              { hour: 14, value: Math.round(baseCapacity * 0.7) },
              { hour: 15, value: Math.round(baseCapacity * 1.1) },
              { hour: 16, value: Math.round(baseCapacity * 0.8) },
              { hour: 17, value: Math.round(baseCapacity * 1.2) },
              { hour: 18, value: Math.round(baseCapacity * 0.9) },
              { hour: 19, value: Math.round(baseCapacity * 1.3) },
              { hour: 20, value: Math.round(baseCapacity * 1.0) },
              { hour: 21, value: Math.round(baseCapacity * 1.4) },
              { hour: 22, value: Math.round(baseCapacity * 1.1) }
            ];
        }
      }
      
      function generateStationSpecificStandData(stationId) {
        // 基于stationId设置随机种子
        const seed = stationId % 5; 
        
        // 总停车位数量
        const totalStands = 20 + (stationId % 15);
        
        // 获取自行车数据（停车位数据与自行车数据相反）
        const bikeData = generateStationSpecificBikeData(stationId);
        
        // 计算停车位（总数减去自行车数）
        return bikeData.map(item => ({
          hour: item.hour,
          value: totalStands - item.value
        }));
      }
      
      // 渲染图表
      function renderChart(chartId, data, hours, title) {
        const chartContainer = document.getElementById(chartId);
        if (!chartContainer) return;
        
        // 清空现有内容
        chartContainer.innerHTML = '';
        
        // 添加标题
        if (title) {
          const titleElement = document.createElement('h4');
          titleElement.textContent = title;
          titleElement.style.textAlign = 'center';
          titleElement.style.margin = '5px 0';
          titleElement.style.fontSize = '14px';
          titleElement.style.color = '#333';
          chartContainer.appendChild(titleElement);
        }
        
        // 找出最大值，用于计算比例
        const maxValue = Math.max(...data.map(item => item.value));
        
        // 创建每个柱形
        data.forEach(item => {
          const barHeight = (item.value / maxValue) * 150; // 最大高度150px (减少一些以留出标题空间)
          const bar = document.createElement('div');
          bar.className = chartId === 'stations-chart' ? 'chart-bar station' : 'chart-bar';
          bar.style.height = `${barHeight}px`;
          
          // 创建提示工具
          const tooltip = document.createElement('div');
          tooltip.className = 'chart-tooltip';
          tooltip.textContent = item.value;
          bar.appendChild(tooltip);
          
          chartContainer.appendChild(bar);
        });
        
        // 添加时间标签
        const timeLabelsContainer = document.createElement('div');
        timeLabelsContainer.className = 'time-labels';
        
        data.forEach(item => {
          const timeLabel = document.createElement('div');
          timeLabel.className = 'time-label';
          timeLabel.textContent = `${item.hour}时`;
          timeLabelsContainer.appendChild(timeLabel);
        });
        
        chartContainer.appendChild(timeLabelsContainer);
      }
      
      // 全局变量存储所有站点数据
      window.allStations = [];
      
      // 浮窗控制函数
      function toggleFilterModal() {
        const modal = document.getElementById('filter-modal');
        modal.classList.toggle('collapsed');
      }
      
      // 填充站点选择器
      function populateStationSelect() {
        const stationSelect = document.getElementById('station-select');
        // 清空当前选项（保留"所有站点"选项）
        while (stationSelect.options.length > 1) {
          stationSelect.remove(1);
        }
        
        // 如果有站点数据，填充选项
        if (window.allStations && window.allStations.length > 0) {
          // 按站点名称排序
          const sortedStations = [...window.allStations].sort((a, b) => {
            return a.Name.localeCompare(b.Name);
          });
          
          // 添加选项
          sortedStations.forEach(station => {
            const option = document.createElement('option');
            option.value = station.Number;
            option.textContent = `${station.Name} (${station.Number})`;
            stationSelect.appendChild(option);
          });
        }
      }
      
      // 应用筛选条件
      function applyFilters() {
        const stationId = document.getElementById('station-select').value;
        const timeValue = document.getElementById('time-select').value;
        
        // 设置起点和终点站点选择
        if (stationId) {
          // 如果选择了特定站点，更新出行计划
          const station = window.allStations.find(s => s.Number == stationId);
          if (station) {
            document.getElementById('start-location').value = station.Name;
            // 随机选择一个不同的站点作为终点
            const otherStations = window.allStations.filter(s => s.Number != stationId);
            if (otherStations.length > 0) {
              const randomEndStation = otherStations[Math.floor(Math.random() * otherStations.length)];
              document.getElementById('end-location').value = randomEndStation.Name;
              
              // 触发路线规划
              planJourney();
            }
          }
        }
        
        // 从后端获取筛选结果
        fetchFilterResults(stationId, timeValue);
      }
      
      // 从后端获取筛选结果
      function fetchFilterResults(stationId, timeValue) {
        const resultsContent = document.querySelector('.results-content');
        resultsContent.innerHTML = '<p>正在加载数据...</p>';
        
        // 构建查询参数
        const params = new URLSearchParams();
        if (stationId) params.append('station_id', stationId);
        params.append('time', timeValue);
        
        // 发送请求到后端API
        fetch(`http://localhost:5002/get_filtered_data?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('网络请求失败');
                }
                return response.json();
            })
            .then(data => {
                // 显示返回的数据
                displayFilterResults(data);
            })
            .catch(error => {
                console.error('获取筛选数据失败:', error);
                displayMockFilterResults(stationId, timeValue);
            });
      }
      
      // 显示筛选结果
      function displayFilterResults(data) {
        const resultsContent = document.querySelector('.results-content');
        
        if (!data || Object.keys(data).length === 0) {
            resultsContent.innerHTML = '<p class="placeholder-text">没有找到匹配的数据</p>';
            return;
        }
        
        // 创建结果HTML
        let html = '<div class="results-data">';
        
        if (data.summary) {
            html += `<p><strong>概要:</strong> ${data.summary}</p>`;
        }
        
        if (data.details) {
            html += '<ul>';
            Object.entries(data.details).forEach(([key, value]) => {
                html += `<li><strong>${key}:</strong> ${value}</li>`;
            });
            html += '</ul>';
        }
        
        html += '</div>';
        resultsContent.innerHTML = html;
      }
      
      function displayMockFilterResults(stationId, timeValue) {
        const resultsContent = document.querySelector('.results-content');
        const time = timeValue || '全天';
        const station = stationId ? `站点 ${stationId}` : '所有站点';
        
        const mockData = {
            summary: `${station} 在 ${time}:00 的数据`,
            details: {
                '平均可用车辆': Math.floor(Math.random() * 10) + 5,
                '平均可用车位': Math.floor(Math.random() * 15) + 10,
                '使用率': `${Math.floor(Math.random() * 100)}%`,
                '数据采集时间': new Date().toLocaleString()
            }
        };
        
        displayFilterResults(mockData);
      }
      
      // 重置筛选条件
      function resetFilters() {
        document.getElementById('station-select').selectedIndex = 0;
        document.getElementById('time-select').selectedIndex = 0;
        
        // 清空筛选结果
        const resultsContent = document.querySelector('.results-content');
        resultsContent.innerHTML = '<p class="placeholder-text">应用筛选后将显示结果...</p>';
        
        // 清空路线规划的输入框
        document.getElementById('start-location').value = '';
        document.getElementById('end-location').value = '';
        
        // 清除地图标记和路线
        if (window.map && window.routeLine) {
          window.routeLine.setMap(null);
        }
        
        // 提供反馈
        alert('已重置筛选条件');
      }
      
      // 加载总体数据（保留原来的功能，但在筛选改为fetchFilterResults调用）
      function loadGeneralData(timeRange) {
        // 解析时间范围
        const [start, end] = timeRange.split('-').map(Number);
        
        // 从API获取自行车可用性数据
        fetch('http://localhost:5002/get_hourly_bikes_data')
          .then(response => response.json())
          .then(bikeData => {
            // 过滤时间范围
            const filteredBikeData = bikeData.filter(item => 
              item.hour >= start && item.hour <= end
            );
            
            // 渲染图表
            renderChart('bikes-chart', filteredBikeData, 
                       Array.from({length: end-start+1}, (_, i) => i + start),
                       "所有站点自行车可用量");
          })
          .catch(error => {
            console.error('Error fetching bike data:', error);
            const mockBikeData = generateHourlyBikeData()
              .filter(item => item.hour >= start && item.hour <= end);
            
            renderChart('bikes-chart', mockBikeData, 
                       Array.from({length: end-start+1}, (_, i) => i + start),
                       "所有站点自行车可用量");
          });
        
        // 从API获取站点可用性数据
        fetch('http://localhost:5002/get_hourly_stations_data')
          .then(response => response.json())
          .then(stationData => {
            // 过滤时间范围
            const filteredStationData = stationData.filter(item => 
              item.hour >= start && item.hour <= end
            );
            
            // 渲染图表
            renderChart('stations-chart', filteredStationData, 
                       Array.from({length: end-start+1}, (_, i) => i + start),
                       "各时段可用站点数量");
          })
          .catch(error => {
            console.error('Error fetching station data:', error);
            const mockStationData = generateHourlyStationData()
              .filter(item => item.hour >= start && item.hour <= end);
            
            renderChart('stations-chart', mockStationData, 
                       Array.from({length: end-start+1}, (_, i) => i + start),
                       "各时段可用站点数量");
          });
      }
      
      // 关闭站点弹窗
      function closeStationPopup() {
        const popup = document.getElementById('station-popup');
        popup.style.display = 'none';
      }
      
      // Fetch station hourly data from API
      function fetchStationHourlyData(stationId) {
        fetch(`http://localhost:5002/get_station_hourly_data/${stationId}`)
          .then(response => response.json())
          .then(data => {
            if (data && data.bikes && data.stands) {
              // If we have real data, use it
              // Convert hours for display
              const hours = data.bikes.map(item => item.hour);
              
              // Generate charts with real data
              generateChart('bikes-chart-container', 'bikes-time-labels', data.bikes, hours, 'bike');
              generateChart('stands-chart-container', 'stands-time-labels', data.stands, hours, 'stand');
            } else {
              // If no real data, fall back to simulated data
              generateStationCharts(stationId);
            }
          })
          .catch(error => {
            console.error('Error fetching station hourly data:', error);
            // Fall back to simulated data
            generateStationCharts(stationId);
          });
      }
      
      // Generate station charts with simulated data (fallback)
      function generateStationCharts(stationId) {
        // Generate hour data - from 4am to 10pm
        const hours = [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22];
        
        // Use a random seed based on station ID to generate consistent data patterns
        const stationSeed = stationId % 5;
        
        // Generate bike availability data
        const bikeData = generateHourlyDataForStation(stationSeed, hours, 'bike');
        generateChart('bikes-chart-container', 'bikes-time-labels', bikeData, hours, 'bike');
        
        // Generate stand availability data
        const standData = generateHourlyDataForStation(stationSeed, hours, 'stand');
        generateChart('stands-chart-container', 'stands-time-labels', standData, hours, 'stand');
      }
      
      // Generate simulated hourly data based on station seed
      function generateHourlyDataForStation(seed, hours, type) {
        const totalCapacity = 20 + (seed * 5);
        const data = [];
        
        // Create different usage patterns based on seed and type
        if (type === 'bike') {
          // Bike availability patterns
          switch(seed) {
            case 0: // Low in morning/evening, high at midday (work area)
              hours.forEach(hour => {
                let value;
                if (hour < 7) value = totalCapacity * 0.9; // Most available in early morning
                else if (hour < 10) value = totalCapacity * 0.3; // Few available during morning commute
                else if (hour < 16) value = totalCapacity * 0.7; // Most return during midday
                else if (hour < 19) value = totalCapacity * 0.2; // Few available during evening commute
                else value = totalCapacity * 0.8; // Most return in evening
                data.push({ hour, value: Math.round(value + (Math.random() * 3 - 1.5)) });
              });
              break;
            case 1: // High in morning/evening, low at midday (residential area)
              hours.forEach(hour => {
                let value;
                if (hour < 7) value = totalCapacity * 0.3; // Few available in early morning
                else if (hour < 10) value = totalCapacity * 0.8; // Many available during morning commute
                else if (hour < 16) value = totalCapacity * 0.4; // Few at midday
                else if (hour < 19) value = totalCapacity * 0.9; // Many available during evening commute
                else value = totalCapacity * 0.5; // Average in evening
                data.push({ hour, value: Math.round(value + (Math.random() * 3 - 1.5)) });
              });
              break;
            case 2: // Weekend pattern (relatively steady but low at midday)
              hours.forEach(hour => {
                let value;
                if (hour < 10) value = totalCapacity * 0.7;
                else if (hour < 14) value = totalCapacity * 0.4;
                else if (hour < 18) value = totalCapacity * 0.5;
                else value = totalCapacity * 0.7;
                data.push({ hour, value: Math.round(value + (Math.random() * 3 - 1.5)) });
              });
              break;
            case 3: // Tourist area (high in morning, gradually decreasing)
              hours.forEach(hour => {
                let value = totalCapacity * (0.8 - (hour - 4) * 0.03);
                data.push({ hour, value: Math.round(value + (Math.random() * 3 - 1.5)) });
              });
              break;
            default: // Steady pattern
              hours.forEach(hour => {
                let value = totalCapacity * 0.6 + (Math.random() * 0.2);
                data.push({ hour, value: Math.round(value) });
              });
          }
        } else { // Stand data (inverse of bike data)
          const bikeData = generateHourlyDataForStation(seed, hours, 'bike');
          hours.forEach((hour, index) => {
            data.push({ 
              hour, 
              value: Math.round(totalCapacity - bikeData[index].value) 
            });
          });
        }
        
        return data;
      }
      
      // Generate chart
      function generateChart(containerId, labelsId, data, hours, type) {
        const container = document.getElementById(containerId);
        const labelsContainer = document.getElementById(labelsId);
        
        // Clear containers
        container.innerHTML = '';
        labelsContainer.innerHTML = '';
        
        // Find maximum value
        const maxValue = Math.max(...data.map(item => item.value)) * 1.1; // Add 10% space
        
        // Draw bar chart
        data.forEach(item => {
          const barHeight = (item.value / maxValue) * 100;
          const bar = document.createElement('div');
          bar.className = `chart-bar ${type}`;
          bar.style.height = `${barHeight}%`;
          bar.setAttribute('data-value', item.value);
          container.appendChild(bar);
        });
        
        // Add time labels (only show some hours to avoid crowding)
        const showLabels = [4, 8, 12, 16, 20];
        hours.forEach(hour => {
          const label = document.createElement('div');
          label.className = 'time-label';
          label.textContent = showLabels.includes(hour) ? `${hour}` : '';
          labelsContainer.appendChild(label);
        });
      }
      
      // Set as start point, update input field and provide feedback
      function selectAsStart(stationName) {
        document.getElementById('start-location').value = stationName;
        window.selectedStartStation = stationName;
        console.log('Set as start point:', stationName);
        
        // Update markers on the map
        updateStationMarkers();
      }
      
      // Set as end point, update input field and provide feedback
      function selectAsEnd(stationName) {
        document.getElementById('end-location').value = stationName;
        window.selectedEndStation = stationName;
        console.log('Set as end point:', stationName);
        
        // Update markers on the map
        updateStationMarkers();
      }
      
      // Update the display of start and end markers on the map
      function updateStationMarkers() {
        // Remove previous start and end markers if they exist
        if (window.startPointMarker) {
          window.startPointMarker.setMap(null);
        }
        if (window.endPointMarker) {
          window.endPointMarker.setMap(null);
        }
        
        // Reset all regular station markers to default purple
        if (window.stationMarkers) {
          window.stationMarkers.forEach(marker => {
            marker.setIcon({
              path: google.maps.SymbolPath.CIRCLE,
              fillColor: '#8A2BE2', // Purple
              fillOpacity: 1,
              strokeWeight: 0,
              scale: 10
            });
          });
        }
        
        // Find matching start and end station markers and set special styles
        const stations = window.stations || [];
        
        // Handle start point
        if (window.selectedStartStation) {
          const startStation = findStationByNameOrAddress(stations, window.selectedStartStation);
          if (startStation) {
            const startPos = { 
              lat: parseFloat(startStation.Latitude), 
              lng: parseFloat(startStation.Longitude) 
            };
            
            // Create new start marker
            window.startPointMarker = new google.maps.Marker({
              position: startPos,
              map: window.map,
              title: 'Start: ' + startStation.Name,
              zIndex: 1000, // Ensure above other markers
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#4CAF50', // Green
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: '#FFFFFF',
                scale: 12
              }
            });
          }
        }
        
        // Handle end point
        if (window.selectedEndStation) {
          const endStation = findStationByNameOrAddress(stations, window.selectedEndStation);
          if (endStation) {
            const endPos = { 
              lat: parseFloat(endStation.Latitude), 
              lng: parseFloat(endStation.Longitude) 
            };
            
            // Create new end marker
            window.endPointMarker = new google.maps.Marker({
              position: endPos,
              map: window.map,
              title: 'End: ' + endStation.Name,
              zIndex: 1000, // Ensure above other markers
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#F44336', // Red
                fillOpacity: 1,
                strokeWeight: 2,
                strokeColor: '#FFFFFF',
                scale: 12
              }
            });
          }
        }
        
        // If both start and end are set, auto-fit map to include both
        if (window.startPointMarker && window.endPointMarker) {
          const bounds = new google.maps.LatLngBounds();
          bounds.extend(window.startPointMarker.getPosition());
          bounds.extend(window.endPointMarker.getPosition());
          window.map.fitBounds(bounds);
          
          // Highlight connecting route
          highlightRoute();
        }
      }
      
      // Function to determine station marker color based on bike availability
      function getStationColor(station) {
        // Get available bikes and total capacity
        const availableBikes = parseInt(station.Available_bikes || station.available_bikes || 0);
        const totalCapacity = parseInt(station.Bike_stands || station.bike_stands || 20);
        
        // Calculate availability ratio
        const ratio = totalCapacity > 0 ? availableBikes / totalCapacity : 0;
        
        // Return color based on availability
        if (ratio > 0.7) return '#4CAF50'; // Green - plenty of bikes
        if (ratio > 0.3) return '#FFC107'; // Yellow - moderate availability
        return '#F44336';                  // Red - few bikes available
      }
      
      // Submit journey planning request
      function planJourney() {
        const startLocation = document.getElementById('start-location').value;
        const endLocation = document.getElementById('end-location').value;
        const selectedDay = document.querySelector('input[name="journey-date"]:checked').value;
        const selectedTime = document.getElementById('journey-time').value;
        
        if (!startLocation || !endLocation) {
          alert('Please enter start and end locations');
          return;
        }
        
        // Show loading state
        document.getElementById('submit-journey').textContent = 'Calculating Route...';
        document.getElementById('submit-journey').disabled = true;
        
        try {
          // Get station data from backend API
          fetch('http://localhost:5002/get_stations')
            .then(response => response.json())
            .then(stationsData => {
              window.stations = stationsData;
              
              // Find stations matching user input
              const startStation = findStationByNameOrAddress(stationsData, startLocation);
              const endStation = findStationByNameOrAddress(stationsData, endLocation);
              
              if (!startStation) {
                alert(`Could not find a start station matching "${startLocation}"`);
                document.getElementById('submit-journey').textContent = 'Submit';
                document.getElementById('submit-journey').disabled = false;
                return;
              }
              
              if (!endStation) {
                alert(`Could not find an end station matching "${endLocation}"`);
                document.getElementById('submit-journey').textContent = 'Submit';
                document.getElementById('submit-journey').disabled = false;
                return;
              }
              
              // Calculate route using found stations
              calculateRoute(startStation, endStation);
            })
            .catch(error => {
              console.error('Error loading stations:', error);
              
              // If API is unavailable, try to use markers data from the page
              if (window.stationMarkers && window.stationMarkers.length > 0) {
                // Generate temporary station data based on map markers
                const mockStations = window.stationMarkers.map((marker, index) => {
                  const position = marker.getPosition();
                  return {
                    Number: index + 1,
                    Name: marker.getTitle() || `Station ${index + 1}`,
                    Address: marker.getTitle() || `Address ${index + 1}`,
                    Latitude: position.lat(),
                    Longitude: position.lng(),
                    Available_bikes: Math.floor(Math.random() * 10) + 1,
                    Available_bike_stands: Math.floor(Math.random() * 10) + 1
                  };
                });
                
                // Set to global variable for other functions to use
                window.stations = mockStations;
                
                // Continue with mock data to find matching stations
                const startStation = findStationByNameOrAddress(mockStations, startLocation);
                const endStation = findStationByNameOrAddress(mockStations, endLocation);
                
                if (!startStation) {
                  alert(`Could not find a start station matching "${startLocation}"`);
                  document.getElementById('submit-journey').textContent = 'Submit';
                  document.getElementById('submit-journey').disabled = false;
                  return;
                }
                
                if (!endStation) {
                  alert(`Could not find an end station matching "${endLocation}"`);
                  document.getElementById('submit-journey').textContent = 'Submit';
                  document.getElementById('submit-journey').disabled = false;
                  return;
                }
                
                // Calculate route using found stations
                calculateRoute(startStation, endStation);
              } else {
                alert('Unable to load station data. Please try again later.');
                document.getElementById('submit-journey').textContent = 'Submit';
                document.getElementById('submit-journey').disabled = false;
              }
            });
        } catch(error) {
          alert('Error calculating route: ' + error.message);
          document.getElementById('submit-journey').textContent = 'Submit';
          document.getElementById('submit-journey').disabled = false;
        }
      }
    </script>
  </body>
</html>